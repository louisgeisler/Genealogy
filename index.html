<!DOCTYPE html>
<html>
<head>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DRZBYQ8WGS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-DRZBYQ8WGS');
    </script>

	<title>MaFamille</title>
    <meta charset="utf-8" />
    <title>Protected Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="#">
	<meta name="description" content="Arbre Généalogique Louis Geisler" />
	<meta name="author" content="Louis Geisler" />

    <style>
        * {
			margin: 0px;
			padding: 0px;
            font-family: 'Arial', sans-serif;
            text-decoration: none;
		}
		
		html, body, section {
			height: 100vh;
			width: 100vw;
			scroll-behavior: smooth;
            box-sizing: border-box;
		}
        
        /*
        section {
            padding: 0px 30px;
        }
        */

		section:not(:target) {
			display: none;
			visibility: hidden;
		}

        button {
            color: white;
            background-color: black;
            border-radius: 4vmin;
            cursor: pointer;
        }
    </style>
    <script>
        const log = console.log;
        const error = console.error;
        const assert = console.assert;
        const $ = function(e) {
            return document.getElementById(e);
        };
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                // Generate a random index
                const j = Math.floor(Math.random() * (i + 1));

                // Swap elements array[i] and array[j]
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function choose(choices) {
            var index = Math.floor(Math.random() * choices.length);
            return choices[index];
        };
        function remove_elements_from_array(array, elementsToRemove) {
            const elementsSet = new Set(elementsToRemove);
            return array.filter(item => !elementsSet.has(item));
        }
    </script>
</head>
<body>

<section id="Loading">

    <style>

        #loader {
            width: 100%;
            height: 100%;
            border: 10vmin solid;
            border-image: conic-gradient(transparent var(--angle), black 0 100%) 1;
            /*
            background-image: conic-gradient(transparent var(--angle), rgba(var(--color), calc(255 - var(--color)), 0, 1) 0 100%) 1;
            */
            animation: rotate linear infinite forwards 3s;
            
			box-sizing: border-box;
            padding: 10vmin;
		}

    </style>
    <div id="loader" class="text2fit">
            Loading...
    </div>
    <script>

        function loader () {
            window.location.href = "#Loading";
            window.onresize();
        }

    </script>

</section>

<section id="Main">
    
    <style>
		#main_container {
            background: white;
			gap: 4vmin;
			padding: 4vmin;
			display: grid;
			grid-template-areas:
                "dynamic"
				"pdf_button"
				"trombi"
				"relat"
				"download_pdf"
				"download_csv"
				"info"
                "wa_btn"
				"coffee";
			justify-items: stretch;
			align-content: stretch;
            grid-template-rows: repeat(9, 1fr);
			grid-template-columns: 1fr;
			height: 100%;
			width: 100%;
			box-sizing: border-box;
		}
		#main_container > * {
			justify-items: stretch;
			align-content: stretch;
            justify-content: center;
            display: flex;
            align-items: center;
		}
        #coffee {
            background: #FFDD00;
            color: black;
			display: grid;
			grid-template-areas:
				"icon1 coffee_text icon2";
			justify-items: stretch;
			align-content: stretch;
            grid-template-rows: 1fr;
			grid-template-columns: 3fr 9fr 2fr;
        }
        .wa_btn {
            background: #3AC04C;
            color: white;
			display: grid;
			grid-template-areas:
				"icon1 coffee_text icon2";
			justify-items: stretch;
			align-content: stretch;
            grid-template-rows: 1fr;
			grid-template-columns: 2fr 9fr 2fr;
        }
		.wa_btn > * {
			justify-items: stretch;
			align-content: stretch;
            justify-content: center;
            display: flex;
            align-items: center;
			height: 100%;
			width: 100%;
		}
        .wa_btn > .icon {
            color: white;
            background: url("https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg") no-repeat center/contain;
        }
        .icon {
			height: 100%;
			width: 100%;
        }
        #coffee > .icon {
            color: white;
            background: url("https://cdn.buymeacoffee.com/widget/assets/coffee%20cup.svg") no-repeat center/contain;
        }
		#coffee > * {
			justify-items: stretch;
			align-content: stretch;
            justify-content: center;
            display: flex;
            align-items: center;
			height: 100%;
			width: 100%;
		}
    </style>

    <div id="main_container">
        <button id="dynamic" style="grid-area: dynamic;" class="text2fit">🚧 Arbre Dynamique 🚧</button>
        <button id="pdf_button" style="grid-area: pdf_button;" class="text2fit">Arbre Statique</button>
        <button id="trombi" style="grid-area: trombi;" class="text2fit">Trombinoscope</button>
        <button id="relat" style="grid-area: relat;" class="text2fit">Relationoscope</button>
        <button id="download_pdf" style="grid-area: download_pdf;" class="text2fit">Arbre Généalogique (PDF)</button>
        <button id="download_csv" style="grid-area: download_csv;" class="text2fit">Arbre Généalogique (CSV)</button>
        <button id="info" style="grid-area: info;" class="text2fit">Plus d'Information</button>
        <button class="wa_btn" style="grid-area: wa_btn;">
            <div class="icon" style="grid-area: icon1;"></div>
            <div style="grid-area: coffee_text;" class="text2fit">Groupe WhatsApp</div>
            <div class="icon" style="grid-area: icon2;"></div>
        </button>
        <button id="coffee" style="grid-area: coffee;" onclick="window.open('https://www.buymeacoffee.com/louisgeisler', '_blank').focus()">
            <div class="icon" style="grid-area: icon1;"></div>
            <div id="coffee_text" style="grid-area: coffee_text;" class="text2fit">Offrir un café</div>
            <div class="icon" style="grid-area: icon2;"></div>
        </button>
    </div>
    <script>

        let nodes = [];
        let html_info_family;
        let whatsapp_conv_url;
        let individuals = {};   

        function parseCSVWithWorker(data) {
            return new Promise((resolve, reject) => {
                const worker = new Worker('csvParserWorker.js');

                worker.onmessage = function(event) {
                    const receivedData = event.data;
                    
                    if (receivedData.error) {
                        reject(new Error(receivedData.error));
                    } else {
                        resolve(receivedData);
                    }
                    
                    // Terminate the worker after it's done
                    worker.terminate();
                };

                worker.onerror = function(error) {
                    reject(new Error("There was an error with the Worker process."));
                };

                // Send both filePath and passphrase to the worker
                worker.postMessage(data, [data]);
            });
        }         

        function parseCSV(data) {
            data = new TextDecoder().decode(data);

            // Trim the data to remove any leading/trailing whitespace or newlines
            data = data.trim();

            let results = [];
            let rows = data.split('\n');

            // If there's no data or headers, return an empty array
            if (rows.length === 0) return results;

            let headers = parseCSVRow(rows[0]);

            for (let i = 1; i < rows.length; i++) {
                // If the row is empty, continue to the next iteration
                if (!rows[i].trim()) continue;

                let cells = parseCSVRow(rows[i]);
                let obj = {};

                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j].trim()] = cells[j] ? cells[j].trim() : '';
                }

                results.push(obj);
            }

            return results;
        }

        function parseCSVRow(row) {
            let cells = [];
            let inQuotes = false;
            let currentCell = '';

            for(let i = 0; i < row.length; i++) {
                let char = row[i];

                if(inQuotes) {
                    if(char === '"') {
                        if(i < row.length - 1 && row[i+1] === '"') {
                            // Handle double quote escape sequence
                            currentCell += '"';
                            i++; // Skip next character
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        currentCell += char;
                    }
                } else {
                    if(char === ',') {
                        cells.push(currentCell);
                        currentCell = '';
                    } else if(char === '"') {
                        inQuotes = true;
                    } else {
                        currentCell += char;
                    }
                }
            }

            cells.push(currentCell);

            return cells;
        }


        function decryptWithWorker(filePath, passphrase) {
            return new Promise((resolve, reject) => {
                const worker = new Worker('decryptionWorker.js');

                worker.onmessage = function(event) {
                    const receivedData = event.data;
                    
                    if (receivedData.error) {
                        reject(new Error(receivedData.error));
                    } else {
                        resolve(receivedData);
                    }
                    
                    // Terminate the worker after it's done
                    worker.terminate();
                };

                worker.onerror = function(error) {
                    reject(new Error("There was an error with the Worker process."));
                };

                // Send both filePath and passphrase to the worker
                worker.postMessage({ filePath: filePath, passphrase: passphrase });
            });
        }


        async function processFilesAndData(passphrase) {

            
            let startTime = performance.now();
            let [decrypted_data_buffer, csv_data, pdf_data_buffer] = await Promise.all([
                decryptWithWorker('./data.encrypted.txt', passphrase),
                decryptWithWorker('./output.encrypted.csv', passphrase),
                    //.then(parseCSVWithWorker),
                decryptWithWorker('./Geisler.encrypted.pdf', passphrase)
            ]);

            //csv_data = await parseCSVWithWorker(csv_data);
            csv_data = parseCSV(csv_data);
            log("Time to decypt files:", performance.now() - startTime, "ms");

            const decoded_data = new TextDecoder().decode(decrypted_data_buffer);
            decrypted_html = new DOMParser().parseFromString(decoded_data, "text/html");

            html_info_family = decrypted_html.getElementById("info_gen_template").innerHTML;
            whatsapp_conv_url = decrypted_html.getElementById("whatsapp_conv_url").textContent;
            
            function p(pointer) {
                const p2 = (v) => parseInt(v.replace("@", "").replace("I", ""));
                if (Array.isArray(pointer)) {
                    //log(pointer.map(p2));
                    return pointer.map(p2);
                } else {
                    //log(p2(pointer));
                    return p2(pointer);
                }  
            }

            startTime = performance.now();
            csv_data.forEach(e => {
                individuals[e["ID"]] = e;
                nodes.push({
                    id: parseInt(e["ID"].replace("@", "").replace("I", "")),
                    pids: (e["ID Partenaire"])?p([e["ID Partenaire"]]):null,
                    fid: p(e["ID Père"]) || null,
                    mid: p(e["ID Mère"]) || null,
                    name: e["Nom"],
                    bdate: e["Date Naissance"] || null,
                    ddate: e["Date Mort"] || null,
                    location: e["Résidence"] || null,
                    img: e["ImageURL"] || null,
                    gender: {"M": 'male', "F": 'female', "U": null}[e["Sexe"]],
                });
            });
            
            log("Time to load pictures:", performance.now() - startTime, "ms");

            return {
                html_info_family,
                whatsapp_conv_url,
                pdf_data_buffer
            };
        }

        async function main() {

            loader();

            let passwordKey = "pwd";
            let queryParams = new URLSearchParams(window.location.search);
            let passphrase = queryParams.get(passwordKey);

            let { 
                html_info_family,
                whatsapp_conv_url,
                pdf_data_buffer
            } = await processFilesAndData(passphrase);

            const pdf_blob = new Blob([pdf_data_buffer], { type: "application/pdf" });
            const pdf_url = URL.createObjectURL(pdf_blob);

            document.getElementById("iframe").src = (
                pdf_url + "#toolbar=0&view=FitV&scrollbar=1"
            )

            window.location.href = "#Main";

            Array.from(document.getElementsByClassName("wa_btn")).map(e => {e.onclick = () => {
                window.open(whatsapp_conv_url, '_blank').focus();
            }})

            $("download_pdf").onclick = () => {
                const a = document.createElement('a');
                a.href = pdf_url;
                a.download = 'genealogie.pdf'; // Specify the desired file name
                a.style.display = 'none'; // Hide the link
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
    
            $("info").onclick = async () => {
                go_info();
                await go_back();
            };

            $("download_csv").onclick = () => {
                const a = document.createElement('a');
                a.href = csv_url;
                a.download = 'genealogie.csv'; // Specify the desired file name
                a.style.display = 'none'; // Hide the link
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
    
            $("trombi").onclick = async () => {
                let result;
                do {
                    result = await Promise.race([
                        Game.main("trombinoscope"),
                        go_back()
                    ]);
                } while (result=="Retry");
            };

            $("relat").onclick = async () => {
                let result;
                do {
                    result = await Promise.race([
                        Game.main("relationoscope"),
                        go_back()
                    ]);
                } while (result=="Retry");
            };

            $("pdf_button").onclick = async () => {
                pdf();
                await go_back();
            };

            $("dynamic").onclick = async () => {
                graph();
                await go_back();
            };

            window.onresize();
            
        };
    </script>

</section>


<section id="info_family">

    <style>
		#if {
            background: white;
			gap: 4vmin;
			padding: 4vmin;
			display: grid;
			grid-template-areas:
                "header"
				"content"
				"footer";
			justify-items: stretch;
			align-content: stretch;
            grid-template-rows: 1fr 9fr 1fr;
			grid-template-columns: 1fr;
			height: 100%;
			width: 100%;
			box-sizing: border-box;
            /*font-family: "Georgia", Times New Roman, serif;*/
            font-family: "Helvetica Neue", Arial, sans-serif;
            text-align:justify;  
		}
		#main_container > * {
			justify-items: stretch;
			align-content: stretch;
            justify-content: center;
            display: flex;
            align-items: center;
		}
        ul {
            padding-left: 5vw;
        }
        li {
            padding: 2%;
        }
        p {
            text-indent: 3%;
        }
        
    </style>
    <div id='if'>
    </div>
    <script>
        async function go_info() {
            $("if").innerHTML = html_info_family;
            window.location.href='#info_family';
            window.onresize();
        }
    </script>

</section>


<section id="PDF">

    <style>
        #pdf_container {
            width: 100vw;
            height: 100vh;
			box-sizing: border-box;
        }
        #iframe {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    <div id="pdf_container">
        <iframe id="iframe" scrolling="no" frameBorder="0">
        </iframe>
    </div>
    <script>
        function pdf() {
            window.location.href='#PDF';
        }
    </script>

</section>


<section id="PlayGame">
    <style>
        
        .timer {
            border: 5vmin solid;
            border-image: conic-gradient(transparent var(--angle), rgba(var(--color), calc(255 - var(--color)), 0, 1) 0 100%) 1;
            /*
            background-image: conic-gradient(transparent var(--angle), rgba(var(--color), calc(255 - var(--color)), 0, 1) 0 100%) 1;
            */
            animation: rotate linear 1 forwards;
        }

        @keyframes rotate {
            to {
                --angle: 100%;
                --color: 255;
            }
        }

        @property --angle {
            syntax: '<percentage>';
            initial-value: 0%;
            inherits: false;
        }

        @property --color {
            syntax: '<integer>';
            initial-value: 0;
            inherits: false;
        }

		#container {
			gap: 4vmin;
			padding: 4vmin;
			display: grid;
			grid-template-areas:
                "photo score"
				"photo button1"
				"photo button2"
				"photo button3"
				"photo button4";
			justify-items: stretch;
			align-content: stretch;
            grid-template-rows: 1fr repeat(4, 3fr);
			grid-template-columns: 1fr 1fr;
			height: 100vh;
			width: 100vw;
			box-sizing: border-box;
		}
        @media (max-aspect-ratio: 0.9) {
            #container {
                gap: 4vmin;
                padding: 4vmin;
                display: grid;
                grid-template-areas:
                    "photo"
                    "score"
                    "button1"
                    "button2"
                    "button3"
                    "button4";
                justify-items: stretch;
                align-content: stretch;
                grid-template-rows: 8fr 1fr repeat(4, 3fr);
                grid-template-columns: 1fr;
                height: 100%;
                width: 100%;
                box-sizing: border-box;
            }
		}
		#container > * {
			justify-items: stretch;
			align-content: stretch;
		}
        #score {
            grid-area: score;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #photo {
            grid-area: photo;
            color: rgb(0, 255, 0);
            /*border: 10px solid;
            border-image-slice: 100;
            padding: 15px;
            border-image-source: url("./data/portrait_frame.png");*/
        }
        #b0 {
			grid-area: button1; 
        }
        #b1 {
			grid-area: button2; 
        }
        #b2 {
			grid-area: button3; 
        }
        #b3 {
			grid-area: button4; 
        }
        .right_one {
            background-color: lightgreen;
        }
        .wrong_one {
            background: red;
        }
    </style>
    <div id="container">
        <div id="photo" class="text2fit"></div>
        <div id="score" class="text2fit">
            <b>Score:</b> <span id='scoring'>0</span> (<span id="current_round"></span>/<span id="max_round"></span>)
        </div>
        <button id="b0" class="text2fit">0</button>
        <button id="b1" class="text2fit">1</button>
        <button id="b2" class="text2fit">2</button>
        <button id="b3" class="text2fit">3</button>
    </div>
    <script>


        const Game = {

            score: 0,
            round_counter: 0,
            max_round: 6,

            buttons: [...$("container").getElementsByTagName("button")],

            sad_faces: [
                "😞","😒","🙄","😟","😠","😕","🙁","☹️","🥺","😣","😖","😫","😩","😨","😰","😦","😧","😢","😥","😪","😭","😵","🤦‍♀️","🤦‍♂️",
            ],

            happy_faces: [
                "😀","😁","😃","😄","😆","😉","😊","😋","😎","😍","🙂","🤗","🤩",
            ],

            names: {},

            init: function() {
                this.score = 0;
                this.round_counter = 0;
                window.location.href = "#PlayGame";
                names = Object.keys(individuals);
                names = names.filter(e => individuals[e]["ImageURL"]);
                shuffle(names);
                this.names = names;
                $("scoring").innerHTML = this.score;
                $("current_round").innerText = this.round_counter;
                $("max_round").innerText = this.max_round;
                window.onresize();
            },

            possible_name: class {

                constructor () {
                    this.females = names.filter((e) => individuals[e]["Sexe"]=="F");
                    this.males = names.filter((e) => individuals[e]["Sexe"]=="M");
                }

                generate(mysterious) {
                    let possible;
                    if (individuals[mysterious]["Sexe"]=="M") {
                        possible = this.males;
                    } else {
                        possible = this.females;
                    }
                    shuffle(possible);
                    possible = possible.slice(0, 4);
                    possible = possible.filter((e) => e!=mysterious);
                    possible = possible.slice(0, 3);
                    possible.push(mysterious);
                    let range = [];
                    for(let i=0;i<4;i++) {
                        range.push(i)
                    }
                    shuffle(range);
                    let right_index = range.indexOf(3);
                    possible = range.map(i => possible[i]);
                    possible = possible.map(e => individuals[e]["Nom"]);
                    return [possible, right_index];
                }
            },

            possible_relation: class {

                static relations = {
                    "Père": function(ind) {
                        return individuals[ind]["ID Père"];
                    },
                    "Mère": function(ind) {
                        return individuals[ind]["ID Mère"];
                    },
                    "Partenaire": function(ind) {
                        return individuals[ind]["ID Partenaire"];
                    }

                }

                constructor () {}

                generate(mysterious) {

                    let relations = {
                        
                        child_of: function(ind, right=true) {
                            let info = individuals[ind];
                            let right_ones = [
                                info["ID Mère"],
                                info["ID Père"],
                            ].filter(Boolean);
                            let selection;
                            if (right) {
                                if (!right_ones.length) {
                                    return null;
                                }
                                selection=right_ones;
                            } else {
                                selection=remove_elements_from_array(
                                    names,
                                    right_ones
                                )
                            }
                            if (!info["Sexe"] || info["Sexe"]=="U") {
                                return null;
                            }
                            let sex_based_name = {
                                "M": "Fils",
                                "F": "Fille",
                                "U": "Enfant",
                            }[info["Sexe"] || "U"];

                            return selection.map(e => [
                                sex_based_name+" de",
                                e
                            ])
                        },
                        parent_of: function(ind, right=true) {
                            let info = individuals[ind];
                            if (!info["Sexe"] || info["Sexe"]=="U") {
                                return null;
                            }
                            let sex_based_name = {
                                "M": "Père",
                                "F": "Mère",
                                "U": "Parent",
                            }[info["Sexe"]];
                            
                            let right_ones = Object.keys(individuals).filter(
                                i => individuals[i]["ID "+sex_based_name]==info["ID"]
                            )
                            let selection;
                            if (right) {
                                if (!right_ones.length) {
                                    return null;
                                }
                                selection=right_ones;
                            } else {
                                selection=remove_elements_from_array(
                                    names,
                                    right_ones
                                )
                            }
                            return selection.map(e => [
                            sex_based_name+" de",
                                e
                            ])
                        },
                        sibling_of: function(ind, right=true) {
                            let info = individuals[ind];
                            if (!info["Sexe"] || info["Sexe"]=="U") {
                                return null;
                            }
                            let sex_based_name = {
                                "M": "Frère",
                                "F": "Soeur",
                                "U": "?????",
                            }[info["Sexe"]];
                            
                            let right_ones = Object.keys(individuals).filter(
                                i => {
                                    return (
                                        (
                                            individuals[i]["Nom"]!=info["Nom"]
                                        )
                                        &&
                                        (
                                            (
                                                info["ID Père"]
                                                &&
                                                individuals[i]["ID Père"]==info["ID Père"]
                                            ) || (
                                                info["ID Mère"]
                                                &&
                                                individuals[i]["ID Mère"]==info["ID Mère"]
                                            )
                                        )
                                    )
                                }
                            )
                            let selection;
                            if (right) {
                                if (!right_ones.length) {
                                    return null;
                                }
                                selection=right_ones;
                            } else {
                                selection=remove_elements_from_array(
                                    names,
                                    right_ones
                                )
                            }
                            return selection.map(e => [
                                sex_based_name+" de",
                                e
                            ])
                        },
                        parent_in_law_of: function(ind, right=true) {
                            let info = individuals[ind];
                            if (!info["Sexe"] || info["Sexe"]=="U") {
                                return null;
                            }
                            let sex_based_name_query = {
                                "M": "Père",
                                "F": "Mère",
                            }[info["Sexe"]];
                            let sex_based_name = {
                                "M": "Beau Père",
                                "F": "Belle Mère",
                                "U": "?????",
                            }[info["Sexe"]];
                            
                            let right_ones = Object.keys(individuals).filter(
                                i => {
                                    let partner = individuals[i]["ID Partenaire"];
                                    return (
                                        (
                                            partner
                                            &&
                                            individuals[partner]["ID "+sex_based_name_query]
                                            &&
                                            individuals[partner]["ID "+sex_based_name_query]==ind
                                        )
                                    )
                                }
                            )
                            let selection;
                            if (right) {
                                if (!right_ones.length) {
                                    return null;
                                }
                                selection=right_ones;
                            } else {
                                selection=remove_elements_from_array(
                                    names,
                                    right_ones
                                )
                            }
                            return selection.map(e => [
                                sex_based_name+" de",
                                e
                            ])
                        },
                        partner_of: function(ind, right=true) {
                            let info = individuals[ind];
                            
                            let right_ones = [info["ID Partenaire"]].filter(Boolean)
                            let selection;
                            if (right) {
                                if (!right_ones.length) {
                                    return null;
                                }
                                selection=right_ones;
                            } else {
                                selection=remove_elements_from_array(
                                    names,
                                    right_ones
                                )
                            }
                            return selection.map(e => [
                                "Partenaire de",
                                e
                            ])
                        },
                    };

                    let rights =  Object.keys(relations).flatMap(
                        fct => {
                            let r = relations[fct](mysterious, true)
                            //log(fct.toString(), "=>", r)
                            return r
                        }
                    ).filter(Boolean)
                    if (rights.length==0) {
                        error("Il n'y a aucun bon choix...")
                    }
                    let right = choose(rights)
                    
                    let wrongs = Object.values(relations).flatMap(
                        fct => fct(mysterious, false)
                    ).filter(Boolean)

                    for(let i=0;i<5;i++) {
                        shuffle(wrongs)
                    }
                    let possible = wrongs.slice(0, 3)
                    possible.push(right)

                    let range = [];
                    for(let i=0;i<4;i++) {
                        range.push(i)
                    }
                    shuffle(range);
                    let right_index = range.indexOf(3);
                    possible = range.map(i => possible[i])
                    possible = possible.map((e) => {
                        return e[0] +" "+ individuals[e[1]]["Nom"]
                    })
                    return [possible, right_index]
                }
            },

            round: async function(possible_generator) {
                $("photo").innerHTML = "";
                
                let start = Date.now();

                $("container").classList.remove("timer");
                $("container").style.animationPlayState = 'running';

                let mysterious = this.names.pop();
                let [possible, right_index] = possible_generator.generate(mysterious);

                this.buttons.forEach((e) => {
                    e.disabled = false;
                    e.classList.remove("right_one");
                    e.classList.remove("wrong_one");
                })

                $("current_round").innerText = this.round_counter;

                document.getElementById("photo").style.background = "url('" + individuals[mysterious]["ImageURL"] + "') no-repeat center/contain";
                
                window.onresize();

                let right_button = this.buttons[right_index];
                this.buttons.forEach(
                    (e, i) => e.innerText = possible[i]
                );
                
                let duration = 5;
                $("container").style.animationDuration = duration + "s";

                time_out_event = async () => {
                    $("container").classList.add("timer");
                    await new Promise(resolve => 
                        $("container").onanimationend = resolve
                    );
                    $("photo").innerText = choose(this.sad_faces);
                }
                
                click_button_event = async () => {
                    let event;
                    let button;
                    do {
                        event = await new Promise(resolve => 
                            $("container").onclick = resolve
                        );
                        button = event.target.closest('button');
                    } while (!button);
                    let time_taken = Math.abs(Date.now() - start) + 1;
                    if (button==right_button) {
                        //log(duration*1000, time_taken, Math.round((time_taken / (duration*1000)) * 100))
                        let new_score = Math.round(
                            (1 - Math.max(
                                    Math.min(
                                        (time_taken / (duration*1000)),
                                        1
                                    ),
                                    0
                                )**(1.5)
                            ) * 100
                        );
                        this.score += new_score;
                        $("photo").innerHTML = choose(this.happy_faces)+"<br><b>+"+new_score+"</b>";
                    } else {
                        button.classList.add("wrong_one");
                        $("photo").innerText = choose(this.sad_faces);
                    }
                }

                await Promise.race([
                    time_out_event(),
                    click_button_event()
                ])
                
                //$("container").classList.remove("timer");
                $("container").style.animationPlayState = 'paused';

                this.buttons.forEach((e) => {e.disabled = true;})

                $("container").onclick = null;

                $("scoring").innerText = this.score;
                
                right_button.classList.add("right_one");

                window.onresize();
            },

            main: async function(mode) {
                this.init();
                let possible_generator = {
                    "trombinoscope": new this.possible_name(),
                    "relationoscope": new this.possible_relation()
                }[mode]
                log(mode, possible_generator)
                for(;this.round_counter<this.max_round;) {
                    this.round_counter++;
                    await this.round(possible_generator);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                };
                return await final(mode);
            },
        }

    </script>
</section>

<section id="EndGame">

    <style>
        #highscore {
			gap: 4vmin;
			padding: 4vmin;
			display: grid;
			grid-template-areas:
                "phrase"
                "leaderboard"
                "share"
				"retry";
			justify-items: stretch;
			align-content: stretch;
            grid-template-rows: 2fr 7fr 1fr 1fr;
			grid-template-columns: 1fr;
			height: 100vh;
			width: 100vw;
			box-sizing: border-box;
        }
		#highscore > * {
			justify-items: stretch;
			align-content: stretch;
		}
        #retry {
            grid-area: retry;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #lbc {
            grid-area: leaderboard;
            overflow-y: scroll;
            overflow-x:hidden;
            border: solid 1vmin black;
            border-radius: 2vmin;
        }

        #leaderboard {
            padding-left: 0%;
            font-size: 5vmin;
        }

        #leaderboard > li {
            padding: 0%;
        }

        #leaderboard {
            width: 100%; /* Take full width of the parent */
            border-collapse: collapse; /* Collapse borders */
        }

        /* width */
        ::-webkit-scrollbar {
            width: 20px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px grey;
        }
        
        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: black; 
            border-radius: 10px;
        }

        #leaderboard thead th {
            background-color: #f5f5f5; /* Background color for headers */
            border-bottom: 2px solid #ddd; /* Border for headers */
            position: sticky;
            top: 0; /* Stick to the top */
            z-index: 10; /* Appear on top of other rows when scrolling */
            padding: 10px 15px; /* Padding for headers */
        }

        #leaderboard tbody td {
            padding: 10px 15px; /* Padding for cells */
            border-bottom: 1px solid #ddd; /* Border for cells */
        }

        #leaderboard thead th {
            color: white;
            background-color: black;
        }

    </style>
    <div id="highscore">
        <div class="text2fit" style="grid-area: phrase;">
            <b>Ton Score:</b> <span id="final_score"></span> <span id="emoji"></span>
            <hr>
            Vous êtes dans le Top <span id="rank"></span>
            <hr>
            ⬇️ Meilleurs scores ⬇️
        </div>
        <div id="lbc" data-align-vert="false" data-align-horiz="false">
            <table id="leaderboard">
                <thead>
                    <tr>
                        <th>Rang</th>
                        <th>Nom</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-table">
                    <!-- Data will populate here -->
                </tbody>
            </table>
        </div>
        <button id="share" class="wa_btn" style="grid-area: share;">
            <div class="icon" style="grid-area: icon1;"></div>
            <div style="grid-area: coffee_text;" class="text2fit">Partage ton Score</div>
            <div class="icon" style="grid-area: icon2;"></div>
        </button>
        <button id="retry" class="text2fit">Réessayer</button>
    </div>
    
    <!-- Firebase App and Database -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
    <script>

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDrzv1i1_navMkA--gpO07spdGupEK7Akg",
        authDomain: "genealogy-95042.firebaseapp.com",
        databaseURL: "https://genealogy-95042-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "genealogy-95042",
        storageBucket: "genealogy-95042.appspot.com",
        messagingSenderId: "402849492982",
        appId: "1:402849492982:web:711b16d8ad2b27eb81a1d7",
        measurementId: "G-H0JZZ12BT0"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

        function submitScore(username, game) {
            const score = Game.score;
            db.ref(game + '/' + username).set({
                username: username,
                score: score
            }, (error) => {
                if (error) {
                    log('Failed to save the score. It might be due to a higher existing score.');
                } else {
                    log('Score saved successfully.');
                }
            });
        }

        function populateLeaderboard(game) {
            db.ref(game).on('value', snapshot => {
                const data = snapshot.val();
                const tableBody = document.getElementById("leaderboard-table");
                tableBody.innerHTML = ''; // Clear existing data

                if (data) {
                    const sortedData = Object.entries(data).sort((a, b) => b[1].score - a[1].score).slice(0, 10); // Get top 10 scores

                    sortedData.forEach((entry, index) => {
                        const tr = document.createElement('tr');
                        const rankCell = document.createElement('td');
                        const usernameCell = document.createElement('td');
                        const scoreCell = document.createElement('td');

                        rankCell.textContent = index + 1;
                        usernameCell.textContent = entry[1].username;
                        scoreCell.textContent = entry[1].score;

                        tr.appendChild(rankCell);
                        tr.appendChild(usernameCell);
                        tr.appendChild(scoreCell);

                        tableBody.appendChild(tr);
                    });
                }
            });
        }

        function calculateRank(game, newScore) {
            return new Promise((resolve, reject) => {
                db.ref(game).once('value', snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        const scores = Object.values(data).map(entry => entry.score);
                        scores.push(newScore);
                        scores.sort((a, b) => b - a);
                        resolve(scores.indexOf(newScore) + 1);
                    } else {
                        resolve(1);  // If no scores exist, the player is ranked first
                    }
                }).catch(reject);
            });
        }


    </script>
    <script>
        let username='';
        async function final(game_name) {

            let rank = await calculateRank(game_name, Game.score)
            $("rank").innerHTML = rank;
            username = prompt(`Vous êtes dans le Top ${rank}\nEntrez votre Prénom NOM:`, username);
            if (username) {
                username = username.replace(' ', '');
            } else {
                username = '';
            }
            if ((username !== null) && (username != '')) {
                submitScore(username, game_name)
            }
            let emoji_gradient = ["😢", "😓", "😔", "😞", "🙁", "😕", "😶", "😐", "🙂", "😊", "😀", "😃", "😄", "😁", "😆", "🥳"];
            let emoji_index = Math.floor((Game.score / Game.max_round / 100)**2 * (emoji_gradient.length - 1));
            log(Game.score, Game.max_round, (Game.score / Game.max_round / 100), emoji_index)
            $("emoji").innerText = emoji_gradient[emoji_index];

            window.location.href = "#EndGame";
            
            $("final_score").innerText = Game.score;

            populateLeaderboard(game_name);

            window.onresize();

            await new Promise(resolve => 
                $("retry").onclick = resolve
            );

            return "Retry"
        }
    </script>

</section>

<section id="Graph">

    <style>
        .bft-search {
            top: 0% !important;
            right: 50% !important;
            transform: translate(50%, 5%) !important;
            width: 70% !important;
            height: none !important;
            overflow: hidden !important;
        }
        .bft-form-field {
            min-width: 0 !important;
        }
        .bft-family-menu {
            left: 0 !important;
            right: 50% !important;
            transform: translate(0, -100%) !important;
        }
        .bft-toolbar-container {
            right: 50% !important;
            bottom: 0% !important;
            transform: rotate(90deg) !important;
        }
        [data-tlbr="expand"] {
            display: none !important;
        }
        [data-bft-edit-form] {
            z-index: 999;
        }
    </style>
    <script src="https://balkan.app/js/familytree.js"></script> 
    <div id="tree"></div>
    <script>
        
        //FamilyTree.templates.myTemplate = Object.assign({}, FamilyTree.templates.tommy);

        FamilyTree.templates.tommy_male.plus =
            '<circle cx="0" cy="0" r="15" fill="#ffffff" stroke="#aeaeae" stroke-width="1"></circle>'
            + '<line x1="-11" y1="0" x2="11" y2="0" stroke-width="1" stroke="#aeaeae"></line>'
            + '<line x1="0" y1="-11" x2="0" y2="11" stroke-width="1" stroke="#aeaeae"></line>';
        
        FamilyTree.templates.tommy_male.minus =
            '<circle cx="0" cy="0" r="15" fill="#ffffff" stroke="#aeaeae" stroke-width="1"></circle>'
            + '<line x1="-11" y1="0" x2="11" y2="0" stroke-width="1" stroke="#aeaeae"></line>';
        
        FamilyTree.templates.tommy_female.plus =
            '<circle cx="0" cy="0" r="15" fill="#ffffff" stroke="#aeaeae" stroke-width="1"></circle>'
            + '<line x1="-11" y1="0" x2="11" y2="0" stroke-width="1" stroke="#aeaeae"></line>'
            + '<line x1="0" y1="-11" x2="0" y2="11" stroke-width="1" stroke="#aeaeae"></line>';
        
        FamilyTree.templates.tommy_female.minus =
            '<circle cx="0" cy="0" r="15" fill="#ffffff" stroke="#aeaeae" stroke-width="1"></circle>'
            + '<line x1="-11" y1="0" x2="11" y2="0" stroke-width="1" stroke="#aeaeae"></line>';
        
        FamilyTree.templates.tommy_female.defs =
            `<g transform="matrix(0.05,0,0,0.05,-12,-9)" id="heart">
                <path fill="#F57C00" d="M438.482,58.61c-24.7-26.549-59.311-41.655-95.573-41.711c-36.291,0.042-70.938,15.14-95.676,41.694l-8.431,8.909  l-8.431-8.909C181.284,5.762,98.663,2.728,45.832,51.815c-2.341,2.176-4.602,4.436-6.778,6.778 c-52.072,56.166-52.072,142.968,0,199.134l187.358,197.581c6.482,6.843,17.284,7.136,24.127,0.654 c0.224-0.212,0.442-0.43,0.654-0.654l187.29-197.581C490.551,201.567,490.551,114.77,438.482,58.61z"/>
            <g>
            <style>
                .{randId} .bft-edit-form-header, .{randId} .bft-img-button{
                    background-color: #aeaeae;
                }
                .{randId}.male .bft-edit-form-header, .{randId}.male .bft-img-button{
                    background-color: #039BE5;
                }        
                .{randId}.male div.bft-img-button:hover{
                    background-color: #F57C00;
                }
                .{randId}.female .bft-edit-form-header, .{randId}.female .bft-img-button{
                    background-color: #F57C00;
                }        
                .{randId}.female div.bft-img-button:hover{
                    background-color: #039BE5;
                }
            </style>`;
        
        FamilyTree.templates.tommy.defs =
            `<g transform="matrix(0.05,0,0,0.05,-12,-9)" id="heart">
                <path fill="#F57C00" d="M438.482,58.61c-24.7-26.549-59.311-41.655-95.573-41.711c-36.291,0.042-70.938,15.14-95.676,41.694l-8.431,8.909  l-8.431-8.909C181.284,5.762,98.663,2.728,45.832,51.815c-2.341,2.176-4.602,4.436-6.778,6.778 c-52.072,56.166-52.072,142.968,0,199.134l187.358,197.581c6.482,6.843,17.284,7.136,24.127,0.654 c0.224-0.212,0.442-0.43,0.654-0.654l187.29-197.581C490.551,201.567,490.551,114.77,438.482,58.61z"/>
            <g>
            <style>
                .{randId} .bft-edit-form-header, .{randId} .bft-img-button{
                    background-color: #aeaeae;
                }
                .{randId}.male .bft-edit-form-header, .{randId}.male .bft-img-button{
                    background-color: #039BE5;
                }        
                .{randId}.male div.bft-img-button:hover{
                    background-color: #F57C00;
                }
                .{randId}.female .bft-edit-form-header, .{randId}.female .bft-img-button{
                    background-color: #F57C00;
                }        
                .{randId}.female div.bft-img-button:hover{
                    background-color: #039BE5;
                }
            </style>`;

        FamilyTree.templates.tommy.pointer = 
            `<g data-pointer="pointer" transform="matrix(0,0,0,0,100,100)">><g transform="matrix(0.3,0,0,0.3,-17,-17)">
            <polygon fill="rgb(255, 202, 40)" points="53.004,173.004 53.004,66.996 0,120" />
            <polygon fill="rgb(255, 202, 40)" points="186.996,66.996 186.996,173.004 240,120" />
            <polygon fill="rgb(255, 202, 40)" points="66.996,53.004 173.004,53.004 120,0" />
            <polygon fill="rgb(255, 202, 40)" points="120,240 173.004,186.996 66.996,186.996" />
            <circle fill="rgb(255, 202, 40)" cx="120" cy="120" r="30" />
            </g></g>`;

        FamilyTree.templates.tommy.nodeMenuButton =
            `<g style="cursor:pointer;" transform="matrix(1,0,0,1,93,15)" data-ctrl-n-menu-id="{id}">
            <rect x="-4" y="-10" fill="#000000" fill-opacity="0" width="22" height="22">
            </rect>
            <line x1="0" y1="0" x2="0" y2="10" stroke-width="2" stroke="rgb(255, 202, 40)" />
            <line x1="7" y1="0" x2="7" y2="10" stroke-width="2" stroke="rgb(255, 202, 40)" />
            <line x1="14" y1="0" x2="14" y2="10" stroke-width="2" stroke="rgb(255, 202, 40)" />
            </g>`;
        
        FamilyTree.templates.tommy.menuButton =
            `<div style="position:absolute;left:0px;bottom:0px; width:40px;height:50px;cursor:pointer;" data-ctrl-menu="">
            <hr style="background-color: rgb(255, 202, 40); height: 3px; border: none; border: solid 0.5vmin white;">
            <hr style="background-color: rgb(255, 202, 40); height: 3px; border: none; border: solid 0.5vmin white;">
            <hr style="background-color: rgb(255, 202, 40); height: 3px; border: none; border: solid 0.5vmin white;">
            </div>`;
        
        function graph() {

            window.location.href = "#Graph"

            var family = new FamilyTree(document.getElementById("tree"), {
                //enableTouch: true,
                miniMap: false,
                enableSearch: true,
                mouseScrool: FamilyTree.action.zoom,
                nodeBinding: {
                    field_0: 'name',
                    field_1: 'bdate',
                    field_2: 'ddate',
                    field_3: 'location',
                    img_0: 'img'
                },
                nodes: nodes,
                
                interactive: true,
                toolbar: {
                    zoom: true,
                    fit: true,
                    expandAll: true,
                },
                scaleInitial: FamilyTree.match.boundary,
                //lazyLoading: true,
                menu: {
                    pdf: { text: "Export PDF" },
                    png: { text: "Export PNG" },
                    svg: { text: "Export SVG" },
                    csv: { text: "Export CSV" }
                },
                //anim: {func: null, duration: 0},
                //enableTouch: true,
                //keyNavigation: true,
                //enableTouch: false, //bug
                /*
                toolbar: {
                    fullScreen: true,
                    zoom: true,
                    fit: true,
                    expandAll: true,
                },
                scaleInitial: FamilyTree.match.boundary,
                lazyLoading: true,
                anim: {func: null, duration: 0},
                //*/
            });

            setTimeout(
                function triggerClickOnSVGElement() {
                    var svgElements = document.querySelectorAll('g[data-ctrl-up-id="2"]');
                    if (svgElements.length > 0) {
                        var svgElement = svgElements[0];
                        svgElement.dispatchEvent(new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        }));
                    }
                },
                300
            )
            
            family.on('expcollclick', function (sender, isCollapsing, nodeId) {
                var node = family.getNode(nodeId);
                if (isCollapsing) {
                    family.expandCollapse(nodeId, [], node.ftChildrenIds)
                }
                else {
                    family.expandCollapse(nodeId, node.ftChildrenIds, [])
                }
                return false;
            });

            family.on('render-link', function (sender, args) {
                if (args.cnode.ppid != undefined)
                    args.html += '<use data-ctrl-ec-id="' + args.node.id + '" xlink:href="#heart" x="' + (args.p.xa) + '" y="' + (args.p.ya) + '"/>';
                if (args.cnode.isPartner && args.node.partnerSeparation == 30)
                    args.html += '<use data-ctrl-ec-id="' + args.node.id + '" xlink:href="#heart" x="' + (args.p.xb) + '" y="' + (args.p.yb) + '"/>';
            });
            
            
        }
    </script>

</section>


<!-- Corner Buttons Style -->
<style>
	.corner_button {
		font-size: 10vmin !important;
		padding: 0.5vmin;
		color:white;
		background-color: black;
        cursor: pointer;
		/*z-index: 5;*/
        /*opacity: 0.8;*/
	}
</style>


<!-- Go Back Main Button -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
	.go_back {
		border-bottom-right-radius: 1vmin;
		position: fixed;
		left: 0vw;
		top: 0vh;
		border-right: solid 0.25vmax white;
		border-bottom: solid 0.25vmax white;
	}
</style>
<div id="go_back" class="material-icons go_back corner_button">home</div>
<script>
    $("go_back").style.display = "none";
    async function go_back() {
        $("donation").style.display = "inline";
        $("go_back").style.display = "inline";
        await new Promise(resolve => 
            $("go_back").onclick = resolve
        );
        $("go_back").style.display = "none";
        $("donation").style.display = "none";
        window.location.href = "#Main";
        return;
    };
</script>


<!-- Full screen button -->
<style>
	.fullscreen {
		border-bottom-left-radius: 1vmin;
		position: fixed;
		right: 0vw;
		top: 0vh;
		border-left: solid 0.25vmax white;
		border-bottom: solid 0.25vmax white;
	}
</style>
<div class="material-icons fullscreen corner_button" onclick="fullscreen(this)">
	fullscreen
</div>
<script>
	/*
	Fullscreen button
	*/
	var fullscreenActivation = false;
	function fullscreen(btn) {
		var elem = document.documentElement;

		/* View in fullscreen */
		function openFullscreen() {
			btn.innerHTML = "fullscreen_exit";
			if (elem.requestFullscreen) {
				elem.requestFullscreen();
			} else if (elem.webkitRequestFullscreen) { /* Safari */
				elem.webkitRequestFullscreen();
			} else if (elem.msRequestFullscreen) { /* IE11 */
				elem.msRequestFullscreen();
			}
		}

		/* Close fullscreen */
		function closeFullscreen() {
			btn.innerHTML = "fullscreen";
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.webkitExitFullscreen) { /* Safari */
				document.webkitExitFullscreen();
			} else if (document.msExitFullscreen) { /* IE11 */
				document.msExitFullscreen();
			}
		}

		if (fullscreenActivation) {
			closeFullscreen();
			fullscreenActivation = false;
		} else {
			openFullscreen();
			fullscreenActivation = true;
		}
	}
</script>


<!-- text resizing and onload event -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/textfit/2.4.0/textFit.min.js" integrity="sha512-vLs5rAqfvmv/IpN7JustROkGAvjK/L+vgVDFe7KpdtLztqF8mZDfleK2MZj/xuOrWjma0pW+lPCMcBbPKJVC7g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    /*
    Resize texts when windows is resize
    */

    // Where el is the DOM element you'd like to test for visibility
    function isHidden(el) {
        return (el.offsetParent === null)
    }

    window.onresize = (n_time = 2) => {
        //log("resize", n_time);
        for(var e of document.getElementsByClassName("text2fit")) {
            if (!isHidden(e)) {
                textFit(e, {
                    minFontSize:5,
                    maxFontSize: window.innerHeight,
                    alignVert: (e.dataset.alignVert===undefined) || (e.dataset.alignVert!==undefined && e.dataset.alignVert==""),
                    alignHoriz: (e.dataset.alignHoriz===undefined) || (e.dataset.alignHoriz!==undefined && e.dataset.alignHoriz==""),
                });
            }
        }
        if (n_time) {
            setTimeout(() => window.onresize(n_time - 1), 200);
        }
    }

    window.onload = () => {
        //log("window.onload");
        window.onresize();
    }
</script>

<!-- Buy Me A Coffee Button -->
<style>
	#donation {
		border-top-left-radius: 1vmin;
		position: fixed;
		right: 0vw;
		bottom: 0vh;
		border-left: solid 0.25vmax white;
		border-bottom: solid 0.25vmax white;
        background: rgb(255, 221, 0) url(https://cdn.buymeacoffee.com/widget/assets/coffee%20cup.svg) no-repeat center/contain;
        color: white;
        height: 10vmin;
        width: 10vmin;
        display: none;
	}
</style>
<div id="donation" class="corner_button" onclick="$('bmc-wbtn').onclick()"></div>
<style>
    #bmc-wbtn {
        display: none !important;
    }
</style>

<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="louisgeisler" data-description="Support me on Buy me a coffee!" data-message="" data-color="##FFDD00" data-position="Right" data-x_margin="0" data-y_margin="0"></script>


<script>
    main();
</script>

</body>